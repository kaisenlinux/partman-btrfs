Author: Kevin Chevreuil - Kaisen <kaisen@kaisenlinux.org>

--- partman-btrfs-54.orig/fstab.d/btrfs
+++ partman-btrfs-54/fstab.d/btrfs
@@ -12,21 +12,73 @@ for dev in $DEVICES/*; do
 		[ -f "$id/acting_filesystem" ] || continue
 		method=$(cat $id/method)
 		filesystem=$(cat $id/acting_filesystem)
+		mountpoint=$(cat $id/mountpoint)
 		case "$filesystem" in
 		    btrfs)
 			[ -f "$id/mountpoint" ] || continue
-			mountpoint=$(cat $id/mountpoint)
 			# due to #249322, #255135, #258117:
-			if [ "$mountpoint" = "/tmp" ]; then
+			if [ "$mountpoint" = /tmp ]; then
 				rm -f $id/options/noexec
 			fi
+			options=$(get_mountoptions $dev $id)
+			if [ "$options" = defaults ]; then
+				options="relatime,discard,compress=zstd"
+			fi
 			if [ "$mountpoint" = "/" ]; then
-				options="$(get_mountoptions $dev $id),subvol=@rootfs"
-			else
-				options=$(get_mountoptions $dev $id)
+				options="${options:+$options,}subvol=@"
+				path="$path"
+                                echo "$path" / btrfs "$options" 0 0
+                        fi
+			if [ "$mountpoint" = "/boot" ]; then
+                                options="${options:+$options,}subvol=@boot"
+                                boot_path="$path"
+                                echo "$boot_path" /boot btrfs "$options" 0 0
+                        fi
+			if [ "$mountpoint" = "/home" ]; then
+				options="${options:+$options,}subvol=@home"
+				home_path="$path"
+				echo "$home_path" /home btrfs "$options" 0 0
+			fi
+			if [ "$mountpoint" = "/var" ]; then
+				options="${options:+$options,}subvol=@var"
+				var_path="$path"
+				echo "$var_path" /var btrfs "$options" 0 0
+			fi
+			if [ "$mountpoint" = "/var/log" ]; then
+                                options="${options:+$options,}subvol=@var/log"
+                                varlog_path="$path"
+                                echo "$varlog_path" /var/log btrfs "$options" 0 0
+                        fi
+			if [ "$mountpoint" = "/tmp" ]; then
+				options="${options:+$options,}subvol=@tmp"
+				tmp_path="$path"
+				echo "$tmp_path" /tmp btrfs "$options" 0 0
 			fi
-			# There is no btrfs fsck
-			echo "$path" "$mountpoint" btrfs $options 0 0
+			if [ "$mountpoint" = "/srv" ]; then
+                                options="${options:+$options,}subvol=@srv"
+                                srv_path="$path"
+                                echo "$srv_path" /srv btrfs "$options" 0 0
+                        fi
+			if [ "$mountpoint" = "/opt" ]; then
+                                options="${options:+$options,}subvol=@opt"
+                                opt_path="$path"
+                                echo "$opt_path" /opt btrfs "$options" 0 0
+                        fi
+			if [ "$mountpoint" = "/usr" ]; then
+                                options="${options:+$options,}subvol=@usr"
+                                usr_path="$path"
+                                echo "$usr_path" /usr btrfs "$options" 0 0
+                        fi
+			if [ "$mountpoint" = "/usr/share" ]; then
+                                options="${options:+$options,}subvol=@usr/share"
+                                usrshare_path="$path"
+                                echo "$usrshare_path" /usr/share btrfs "$options" 0 0
+                        fi
+			if [ "$mountpoint" = "/usr/local" ]; then
+                                options="${options:+$options,}subvol=@usr/local"
+                                usrlocal_path="$path"
+                                echo "$usrlocal_path" /usr/local btrfs "$options" 0 0
+                        fi
 			;;
 		esac
 	done
--- partman-btrfs-54.orig/mount.d/btrfs
+++ partman-btrfs-54/mount.d/btrfs
@@ -11,19 +11,90 @@ pass=$6
 
 case $type in
     btrfs)
-	# import workaround from Kali's partman-btrfs commit:7f43d2c
 	options="${options%,subvol=*}"
 	#for removing the option subvol,when thats the only option
 	#eg: options=="subvol=@", no comma present
 	options="${options%subvol=*}"
-	mount -t btrfs ${options:+-o "$options"} $fs /target"$mp" || exit 1
-	if [ $mp = / ]; then
-	    btrfs subvolume create /target$mp/@rootfs
-	    chmod 755 /target$mp/@rootfs
-	    umount /target$mp
-	    options="${options:+$options,}subvol=@rootfs"
-	    mount -t btrfs -o $options $fs /target$mp
-	fi
+	mount -t btrfs ${options:+-o "$options"} $fs /target$mp || exit 1
+	case $mp in
+	    /)
+		btrfs subvolume create /target$mp/@
+		chmod 755 /target$mp/@
+		umount /target$mp
+		options="${options:+$options,}subvol=@"
+		mount -t btrfs -o $options $fs /target$mp
+		;;
+	    /boot)
+                btrfs subvolume create /target$mp/@boot
+                chmod 755 /target$mp/@boot
+                umount /target$mp
+                options="${options:+$options,}subvol=@boot"
+                mount -t btrfs -o $options $fs /target$mp
+                ;;
+	    /home)
+		btrfs subvolume create /target$mp/@home
+		chmod 755 /target$mp/@home
+		umount /target$mp
+		options="${options:+$options,}subvol=@home"
+		mount -t btrfs -o $options $fs /target$mp
+		;;
+	    /var)
+		btrfs subvolume create /target$mp/@var
+		chmod 755 /target$mp/@var
+		umount /target$mp
+		options="${options:+$options,}subvol=@var"
+		mount -t btrfs -o $options $fs /target$mp
+		;;
+	    /var/log)
+                btrfs subvolume create /target$mp/@var/log
+                chmod 755 /target$mp/@var/log
+                umount /target$mp
+                options="${options:+$options,}subvol=@var/log"
+                mount -t btrfs -o $options $fs /target$mp
+		;;
+	    /tmp)
+		btrfs subvolume create /target$mp/@tmp
+		chmod 755 /target$mp/@tmp
+		umount /target$mp
+		options="${options:+$options,}subvol=@tmp"
+		mount -t btrfs -o $options $fs /target$mp
+		;;
+	    /srv)
+                btrfs subvolume create /target$mp/@srv
+                chmod 755 /target$mp/@srv
+                umount /target$mp
+                options="${options:+$options,}subvol=@srv"
+                mount -t btrfs -o $options $fs /target$mp
+		;;
+	    /opt)
+                btrfs subvolume create /target$mp/@opt
+                chmod 755 /target$mp/@opt
+                umount /target$mp
+                options="${options:+$options,}subvol=@opt"
+                mount -t btrfs -o $options $fs /target$mp
+		;;
+	    /usr)
+                btrfs subvolume create /target$mp/@usr
+                chmod 755 /target$mp/@usr
+                umount /target$mp
+                options="${options:+$options,}subvol=@usr"
+                mount -t btrfs -o $options $fs /target$mp
+                ;;
+	    /usr/share)
+                btrfs subvolume create /target$mp/@usr/share
+                chmod 755 /target$mp/@usr/share
+                umount /target$mp
+                options="${options:+$options,}subvol=@usr/share"
+                mount -t btrfs -o $options $fs /target$mp
+                ;;
+            /usr/local)
+                btrfs subvolume create /target$mp/@usr/local
+                chmod 755 /target$mp/@usr/local
+                umount /target$mp
+                options="${options:+$options,}subvol=@usr/local"
+                mount -t btrfs -o $options $fs /target$mp
+                ;;
+	esac
 	echo "umount /target$mp"
 	exit 0
 	;;
